{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Create Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
<div class="w-[70%] mx-auto bg-white rounded-lg shadow-md p-8">
    <h1 class="text-2xl font-bold mb-6 text-center text-gray-700">üçΩÔ∏è Create Order</h1>
    <form method="post" action="" class="space-y-6">
        {% csrf_token %}

        <div>
            <label for="name" class="block font-semibold text-gray-700 mb-1">Name:</label>
            <input type="text" id="name" name="name" required
                   class="w-full border border-gray-300 rounded px-4 py-2 focus:ring focus:outline-none">
        </div>

        <div>
            <label for="phone" class="block font-semibold text-gray-700 mb-1">Phone:</label>
            <input type="tel" id="phone" name="phone" required
                   class="w-full border border-gray-300 rounded px-4 py-2 focus:ring focus:outline-none">
        </div>

        <div>
            <label for="menu" class="block font-semibold text-gray-700 mb-1">Menu:</label>
            <select id="menu" name="menu" required
                    class="w-full border border-gray-300 rounded px-4 py-2 focus:ring focus:outline-none">
                <option value="">-- Select Menu --</option>
                {% for item in menu_items %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="item_quantity" class="block font-semibold text-gray-700 mb-1">Item Quantity:</label>
            <input type="number" id="item_quantity" name="item_quantity" value="1" min="1"
                   class="w-full border border-gray-300 rounded px-4 py-2 focus:ring focus:outline-none">
        </div>

        <div id="ingredients-container" class="space-y-4"></div>

        <div>
            <label for="amount" class="block font-semibold text-gray-700 mb-1">Total Amount (BDT):</label>
            <input type="number" id="amount" name="amount" readonly
                   class="w-full border border-gray-300 rounded px-4 py-2 bg-gray-100 text-right font-bold text-lg">
        </div>

        <div class="text-center">
            <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded shadow">
                Create Order
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const menuSelect = document.getElementById('menu');
    const itemQtyInput = document.getElementById('item_quantity');
    const ingredientsContainer = document.getElementById('ingredients-container');
    const amountInput = document.getElementById('amount');

    itemQtyInput.addEventListener('input', calculateTotalAmount);

    menuSelect.addEventListener('change', function () {
        const menuId = this.value;
        ingredientsContainer.innerHTML = '';
        amountInput.value = 0;

        if (menuId) {
            fetch(`${window.location.origin}/api/used_ingredient/?menu_item_id=${menuId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        data.forEach(ingredient => {
                            const div = document.createElement('div');
                            div.className = "flex items-center gap-4 border p-3 rounded-md shadow-sm bg-gray-50";

                            const img = document.createElement('img');
                            img.src = ingredient.picture || "https://via.placeholder.com/50";
                            img.className = "w-14 h-14 rounded";

                            const info = document.createElement('div');
                            info.innerHTML = `
                                <p class="font-semibold text-gray-700">${ingredient.food}</p>
                                <p class="text-sm text-gray-500">Price: ${ingredient.price} BDT</p>
                            `;

                            const wrapper = document.createElement('div');
                            wrapper.className = "flex flex-col items-end ml-auto";

                            const qtyInput = document.createElement('input');
                            qtyInput.type = 'number';
                            qtyInput.min = 0;
                            qtyInput.value = ingredient.quantity || 0;
                            qtyInput.name = `ingredient_${ingredient.ingredient_id}_quantity`;
                            qtyInput.dataset.price = ingredient.price;
                            qtyInput.className = "w-24 border px-2 py-1 rounded text-right mb-1";
                            qtyInput.addEventListener('input', calculateTotalAmount);

                            const costSpan = document.createElement('span');
                            costSpan.className = "text-sm text-green-600 font-semibold";
                            costSpan.dataset.ingredientId = ingredient.ingredient_id;
                            costSpan.textContent = `= ${(ingredient.price * ingredient.quantity).toFixed(2)} BDT`;

                            wrapper.appendChild(qtyInput);
                            wrapper.appendChild(costSpan);

                            const hidden = document.createElement('input');
                            hidden.type = 'hidden';
                            hidden.name = 'ingredient_ids';
                            hidden.value = ingredient.ingredient_id;

                            div.appendChild(img);
                            div.appendChild(info);
                            div.appendChild(wrapper);
                            div.appendChild(hidden);

                            ingredientsContainer.appendChild(div);
                        });

                        calculateTotalAmount();
                    } else {
                        ingredientsContainer.innerHTML = "<p class='text-red-500'>No ingredients found for this menu item.</p>";
                    }
                })
                .catch(error => {
                    console.error("Error fetching ingredients:", error);
                    ingredientsContainer.innerHTML = "<p class='text-red-500'>Error loading ingredients.</p>";
                });
        }
    });

    function calculateTotalAmount() {
        const itemQty = parseFloat(itemQtyInput.value) || 1;
        const quantityInputs = ingredientsContainer.querySelectorAll('input[type="number"]');
        let total = 0;

        quantityInputs.forEach(input => {
            const price = parseFloat(input.dataset.price || 0);
            const quantity = parseFloat(input.value || 0);
            const perIngredientTotal = price * quantity * itemQty;
            total += perIngredientTotal;

            const ingredientId = input.name.split('_')[1];
            const display = ingredientsContainer.querySelector(`[data-ingredient-id="${ingredientId}"]`);
            if (display) {
                display.textContent = `= ${(price * quantity * itemQty).toFixed(2)} BDT`;
            }
        });

        amountInput.value = total.toFixed(2);
    }
});
</script>
</body>
</html>
{% endblock %}
